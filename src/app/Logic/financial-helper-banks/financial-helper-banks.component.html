<div class="financial-helper-container">
  <header>
    <h1>Calculadora Financiera de Descuentos hacia bancos</h1>
  </header>

  <!-- New Discount Calculator Section -->
  <section class="discount-calculator">
    <h2>Calculadora de Descuentos</h2>
    <form [formGroup]="discountForm" (ngSubmit)="calculateDiscounts()">
      <div class="form-group">
        <label for="targetDate">Fecha Objetivo:</label>
        <input
          type="date"
          id="targetDate"
          formControlName="targetDate"
          class="form-control"
          [min]="getMinDate()"
        >
      </div>

      <div class="time-value-toggle">
        <label>
          <input
            type="checkbox"
            [checked]="applyTimeValue"
            (change)="toggleTimeValue()"
          >
          Aplicar Valor del Dinero en el Tiempo
        </label>
      </div>

      <button type="submit" class="calculate-btn" [disabled]="!discountForm.valid || selectedInvoices.size === 0">
        Calcular Descuentos
      </button>
    </form>

    <div class="results" *ngIf="calculationResults !== null">
      <h3>Resultados del Cálculo</h3>
      <div class="results-grid">
        <div class="result-item">
          <span>Valor Original Total:</span>
          <span>{{ calculationResults!.totalOriginal | currency:'USD':'symbol':'1.2-2' }}</span>
        </div>
        <div class="result-item">
          <span>Valor Descontado Total:</span>
          <span>{{ calculationResults!.totalDiscounted | currency:'USD':'symbol':'1.2-2' }}</span>
        </div>
        <div class="result-item highlight">
          <span>Ahorro Total:</span>
          <span>{{ calculationResults!.savings | currency:'USD':'symbol':'1.2-2' }}</span>
        </div>
        <div class="result-item">
          <span>Facturas Válidas:</span>
          <span>{{ calculationResults!.validInvoices }}</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Existing Invoice Table Section -->
  <section class="invoice-table">
    <h2>Facturas</h2>
    <table>
      <thead>
      <tr>
        <th>Seleccionar</th>
        <th>Código</th>
        <th>Descripción</th>
        <th>Cantidad</th>
        <th>Precio Unitario</th>
        <th>Pago Total</th>
        <th>Fecha de Emisión</th>
        <th>Fecha de Vencimiento</th>
        <th>Estado</th>
        <th>Moneda</th>
        <th>Tasa de Cambio</th>
        <th>TCEA</th>
        <th class="future-value">Valor Futuro</th>
        <th>Acciones</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let invoice of invoices | slice:(currentPage-1)*pageSize:currentPage*pageSize">
        <td>
          <input
            type="checkbox"
            [checked]="isInvoiceSelected(invoice.id || '')"
            (change)="toggleInvoiceSelection(invoice.id || '')"
          >
        </td>
        <td>{{ invoice.code }}</td>
        <td>{{ invoice.description }}</td>
        <td>{{ invoice.quantity }}</td>
        <td>{{ invoice.unitPrice | currency:invoice.currency }}</td>
        <td>{{ invoice.totalPayment | currency:invoice.currency }}</td>
        <td>{{ invoice.issueDate | date }}</td>
        <td>{{ invoice.dueDate | date }}</td>
        <td>{{ invoice.status }}</td>
        <td>{{ invoice.currency }}</td>
        <td>{{ invoice.exchangeRate }}</td>
        <td>
          {{ getTCEAPercentage(invoice) | number:'1.2-2' }}%
          <small>({{ getTCEASource(invoice) }})</small>
        </td>
        <td class="future-value">{{ calculateFutureValue(invoice) | currency:invoice.currency }}</td>
        <td class="action-buttons">
          <button class="toggle-btn" (click)="toggleTCEA(invoice.id)">
            {{ invoice.id && useBankTCEA[invoice.id] ? 'Usar TCEA Factura' : 'Usar TCEA Banco' }}
          </button>
          <button class="delete-btn" (click)="deleteInvoice(invoice?.id)">Eliminar</button>
        </td>
      </tr>
      </tbody>
      <tfoot>
      <tr>
        <td colspan="5"><strong>Totales:</strong></td>
        <td>{{ calculateTotalPayment() | currency:'USD':'symbol':'1.2-2' }}</td>
        <td colspan="6"></td>
        <td class="future-value">{{ calculateTotalFutureValue() | currency:'USD':'symbol':'1.2-2' }}</td>
        <td></td>
      </tr>
      </tfoot>
    </table>
  </section>
  <div class="container">
    <h1>Fórmulas Matemáticas para Cálculos Financieros</h1>

    <div class="formula">
      <h2>1. Valor Total de la Factura</h2>
      <p><strong>Fórmula:</strong> <code>TotalAmount = UnitPrice × Quantity</code></p>
      <p><strong>Descripción:</strong> Se utiliza para calcular el monto total de la factura, multiplicando el precio unitario por la cantidad de productos o servicios adquiridos.</p>
    </div>

    <div class="formula">
      <h2>2. Valor Descontado (Aplicando el Tiempo del Dinero)</h2>
      <p><strong>Fórmula:</strong> <code>DiscountedValue = TotalAmount × (1 + TCEA)^(DaysToTarget / 365)</code></p>
      <p><strong>Descripción:</strong> Esta fórmula aplica el concepto de valor del dinero en el tiempo, ajustando el monto total de la factura al valor presente considerando la Tasa de Costo Efectivo Anual (TCEA) y el número de días hasta la fecha objetivo.</p>
    </div>

    <div class="formula">
      <h2>3. Descuento Bancario</h2>
      <p><strong>Fórmula:</strong> <code>DiscountedValue × (1 - TCEA)^(TotalDays - DaysToTarget / 365)</code></p>
      <p><strong>Descripción:</strong> Aplica un descuento adicional al valor descontado, basado en la TCEA del banco, ajustando el monto por el tiempo restante hasta la fecha de vencimiento.</p>
    </div>

    <div class="formula">
      <h2>4. Ahorros Totales</h2>
      <p><strong>Fórmula:</strong> <code>Savings = TotalOriginal - TotalDiscounted</code></p>
      <p><strong>Descripción:</strong> Calcula los ahorros totales restando el valor descontado del monto original, proporcionando una visión clara de los beneficios económicos obtenidos al aplicar los descuentos.</p>
    </div>
  </div>

</div>
