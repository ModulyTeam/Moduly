<div class="financial-helper-container">
  <header>
    <h1>Calculadora Financiera de Descuentos</h1>
    <button (click)="startTutorial()">Iniciar Tutorial</button>
  </header>

  <section class="invoice-table">
    <h2>Facturas</h2>
    <table>
      <thead>
        <tr>
          <th>Código</th>
          <th>Descripción</th>
          <th>Cantidad</th>
          <th>Precio Unitario</th>
          <th>Pago Total</th>
          <th>Fecha de Emisión</th>
          <th>Fecha de Vencimiento</th>
          <th>Estado</th>
          <th>Moneda</th>
          <th>Tasa de Cambio</th>
          <th>TCEA</th>
          <th class="future-value">Valor Futuro</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let invoice of invoices | slice:(currentPage-1)*pageSize:currentPage*pageSize">
          <td>{{ invoice.code }}</td>
          <td>{{ invoice.description }}</td>
          <td>{{ invoice.quantity }}</td>
          <td>{{ invoice.unitPrice | currency:invoice.currency }}</td>
          <td>{{ invoice.totalPayment | currency:invoice.currency }}</td>
          <td>{{ invoice.issueDate | date }}</td>
          <td>{{ invoice.dueDate | date }}</td>
          <td>{{ invoice.status }}</td>
          <td>{{ invoice.currency }}</td>
          <td>{{ invoice.exchangeRate }}</td>
          <td>{{ getTCEAPercentage(invoice) | number:'1.2-2' }}%</td>
          <td class="future-value">{{ calculateFutureValue(invoice) | currency:invoice.currency }}</td>
          <td class="action-buttons">
            <select (change)="updateInvoiceStatus(invoice?.id, $event)">
              <option value="">Actualizar Estado</option>
              <option value="OPEN">Pendiente</option>
              <option value="PAID">Pagada</option>
              <option value="OVERDUE">Vencida</option>
              <option value="CANCELLED">Cancelada</option>
            </select>
            <button class="delete-btn" (click)="deleteInvoice(invoice?.id)">Eliminar</button>
          </td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4"><strong>Totales:</strong></td>
          <td>{{ calculateTotalPayment() | currency:'USD':'symbol':'1.2-2' }}</td>
          <td colspan="6"></td>
          <td class="future-value">{{ calculateTotalFutureValue() | currency:'USD':'symbol':'1.2-2' }}</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
    <!-- Aquí puedes agregar controles de paginación si lo deseas -->
  </section>

  <section class="portfolio-metrics">
    <h2>Métricas de Cartera</h2>
    <div class="metrics-grid">
      <div class="metric-card">
        <h3>Valor NETO</h3>
        <p>{{ calculatePortfolioMetrics().netValue | currency:'USD':'symbol':'1.2-2' }}</p>
      </div>
      <div class="metric-card">
        <h3>Interés Total</h3>
        <p>{{ calculatePortfolioMetrics().totalInterest | currency:'USD':'symbol':'1.2-2' }}</p>
      </div>
      <div class="metric-card">
        <h3>TCEA Promedio Ponderado</h3>
        <p>{{ calculatePortfolioMetrics().weightedTCEA | number:'1.2-2' }}%</p>
      </div>
    </div>
  </section>

  <section class="discount-calculator">
    <h2>Calculadora de Descuentos</h2>
    <form [formGroup]="discountForm" (ngSubmit)="calculateDiscount()">
      <div class="form-group">
        <label for="discountDate">Fecha de Descuento:</label>
        <input type="date" id="discountDate" formControlName="discountDate" required>
      </div>
      <div class="form-group">
        <label for="additionalDiscount">Descuento Adicional (%):</label>
        <input type="number" id="additionalDiscount" formControlName="additionalDiscount" min="0" max="100">
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="enableMaxLoss"> Habilitar pérdida máxima
        </label>
      </div>
      <div class="form-group" *ngIf="discountForm.get('enableMaxLoss')?.value">
        <label for="maxLossAmount">Pérdida máxima aceptable:</label>
        <input type="number" id="maxLossAmount" formControlName="maxLossAmount" min="0">
        <span>(Total a ganar: {{ calculateTotalFutureValue() | currency:'USD':'symbol':'1.2-2' }})</span>
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="enableBalancedDiscount"> Habilitar descuento balanceado
        </label>
      </div>
      <div class="form-group" *ngIf="discountForm.get('enableBalancedDiscount')?.value">
        <label for="maxTotalDiscount">Descuento total máximo por factura (%):</label>
        <input type="number" id="maxTotalDiscount" formControlName="maxTotalDiscount" min="0" max="100">
      </div>
      <button type="submit" [disabled]="!discountForm.valid">Calcular Descuentos</button>
    </form>
  </section>

  <section class="fixed-amount-calculator">
    <h2>Calculadora de Monto Fijo</h2>
    <button (click)="toggleFixedAmountSection()">
      {{ showFixedAmountSection ? 'Ocultar' : 'Mostrar' }} Calculadora de Monto Fijo
    </button>
    <form *ngIf="showFixedAmountSection" [formGroup]="fixedAmountForm" (ngSubmit)="calculateFixedAmountDiscount()">
      <div class="form-group">
        <label for="fixedAmount">Monto Fijo Deseado:</label>
        <input type="number" id="fixedAmount" formControlName="fixedAmount" required>
      </div>
      <div class="form-group">
        <label for="fixedAmountDiscountDate">Fecha de Descuento:</label>
        <input type="date" id="fixedAmountDiscountDate" formControlName="discountDate" required>
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="enableMaxLoss"> Habilitar pérdida máxima
        </label>
      </div>
      <div class="form-group" *ngIf="fixedAmountForm.get('enableMaxLoss')?.value">
        <label for="maxLossAmount">Pérdida máxima aceptable:</label>
        <input type="number" id="maxLossAmount" formControlName="maxLossAmount" min="0">
        <span>(Total a ganar: {{ calculateTotalFutureValue() | currency:'USD':'symbol':'1.2-2' }})</span>
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="enableBalancedDiscount"> Habilitar descuento balanceado
        </label>
      </div>
      <div class="form-group" *ngIf="fixedAmountForm.get('enableBalancedDiscount')?.value">
        <label for="maxTotalDiscount">Descuento total máximo por factura (%):</label>
        <input type="number" id="maxTotalDiscount" formControlName="maxTotalDiscount" min="0" max="100">
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="enableMaxDesiredDiscount"> Habilitar descuento máximo deseado
        </label>
      </div>
      <div class="form-group" *ngIf="fixedAmountForm.get('enableMaxDesiredDiscount')?.value">
        <label for="maxDesiredDiscount">Descuento máximo deseado (%):</label>
        <input type="number" id="maxDesiredDiscount" formControlName="maxDesiredDiscount" min="0" max="100">
      </div>
      <button type="submit" [disabled]="!fixedAmountForm.valid">Calcular Descuento para Monto Fijo</button>
    </form>
  </section>

  <section class="results-table" *ngIf="discountResults.length > 0">
    <h2>Resultados del Cálculo</h2>
    <table>
      <thead>
        <tr>
          <th>Código</th>
          <th>Monto Original</th>
          <th>Días de Anticipación</th>
          <th>Descuento Base</th>
          <th>Descuento Adicional</th>
          <th>Descuento Total</th>
          <th>Monto Final</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let result of discountResults">
          <td>{{ result.code }}</td>
          <td>{{ result.totalPayment | currency:'USD':'symbol':'1.2-2' }}</td>
          <td>{{ result.daysEarly }}</td>
          <td>{{ result.baseDiscount | number:'1.2-2' }}%</td>
          <td>{{ result.additionalDiscount | number:'1.2-2' }}%</td>
          <td>{{ result.totalDiscount | number:'1.2-2' }}%</td>
          <td>{{ (result.finalDiscountedAmount || result.discountedAmount) | currency:'USD':'symbol':'1.2-2' }}</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td><strong>Totales:</strong></td>
          <td>{{ calculateTotalOriginalAmount() | currency:'USD':'symbol':'1.2-2' }}</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>{{ calculateAverageTotalDiscount() | number:'1.2-2' }}%</td>
          <td>{{ calculateTotalFinalAmount() | currency:'USD':'symbol':'1.2-2' }}</td>
        </tr>
      </tfoot>
    </table>

    <div class="explanation" [innerHTML]="explanation"></div>
  </section>
</div>
